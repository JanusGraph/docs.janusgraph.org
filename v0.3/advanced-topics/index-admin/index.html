



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Index Management - JanusGraph</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../theme/structor-menu.css">
    
      <link rel="stylesheet" href="../../theme/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#index-management" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="JanusGraph" class="md-header-nav__button md-logo">
          
            <img src="../../janusgraph-logomark.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              JanusGraph
            </span>
            <span class="md-header-nav__topic">
              
                Index Management
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/janusgraph/janusgraph/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    JanusGraph
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="JanusGraph" class="md-nav__button md-logo">
      
        <img src="../../janusgraph-logomark.svg" width="48" height="48">
      
    </a>
    JanusGraph
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/janusgraph/janusgraph/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    JanusGraph
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      JanusGraph Basics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        JanusGraph Basics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/schema/" title="Schema and Data Modeling" class="md-nav__link">
      Schema and Data Modeling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/gremlin/" title="Gremlin Query Language" class="md-nav__link">
      Gremlin Query Language
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/server/" title="JanusGraph Server" class="md-nav__link">
      JanusGraph Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/deployment/" title="Deployment Scenarios" class="md-nav__link">
      Deployment Scenarios
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/configured-graph-factory/" title="ConfiguredGraphFactory" class="md-nav__link">
      ConfiguredGraphFactory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/multi-node/" title="Things to Consider in a Multi-Node JanusGraph Cluster" class="md-nav__link">
      Things to Consider in a Multi-Node JanusGraph Cluster
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/index-performance/" title="Indexing for Better Performance" class="md-nav__link">
      Indexing for Better Performance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/transactions/" title="Transactions" class="md-nav__link">
      Transactions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/cache/" title="JanusGraph Cache" class="md-nav__link">
      JanusGraph Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/transaction-log/" title="Transaction Log" class="md-nav__link">
      Transaction Log
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/configuration-reference/" title="Configuration Reference" class="md-nav__link">
      Configuration Reference
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/example-config/" title="Config Example" class="md-nav__link">
      Config Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/common-questions/" title="Common Questions" class="md-nav__link">
      Common Questions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../basics/technical-limitations/" title="Technical Limitations" class="md-nav__link">
      Technical Limitations
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Storage Backends
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Storage Backends
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage-backend/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage-backend/cassandra/" title="Apache Cassandra" class="md-nav__link">
      Apache Cassandra
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage-backend/hbase/" title="Apache HBase" class="md-nav__link">
      Apache HBase
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage-backend/bigtable/" title="Google Cloud Bigtable" class="md-nav__link">
      Google Cloud Bigtable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage-backend/bdb/" title="Oracle Berkeley DB Java Edition" class="md-nav__link">
      Oracle Berkeley DB Java Edition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../storage-backend/inmemorybackend/" title="InMemory Storage Backend" class="md-nav__link">
      InMemory Storage Backend
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Index Backends
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Index Backends
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/search-predicates/" title="Search Predicates and Data Types" class="md-nav__link">
      Search Predicates and Data Types
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/text-search/" title="Index Parameters and Full-Text Search" class="md-nav__link">
      Index Parameters and Full-Text Search
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/field-mapping/" title="Field Mapping" class="md-nav__link">
      Field Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/direct-index-query/" title="Direct Index Query" class="md-nav__link">
      Direct Index Query
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/elasticsearch/" title="Elasticsearch" class="md-nav__link">
      Elasticsearch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/solr/" title="Apache Solr" class="md-nav__link">
      Apache Solr
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../index-backend/lucene/" title="Apache Lucene" class="md-nav__link">
      Apache Lucene
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Advanced Topics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Advanced Topics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../advschema/" title="Advanced Schema" class="md-nav__link">
      Advanced Schema
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../eventual-consistency/" title="Eventually-Consistent Storage Backends" class="md-nav__link">
      Eventually-Consistent Storage Backends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../recovery/" title="Failure & Recovery" class="md-nav__link">
      Failure & Recovery
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Index Management
      </label>
    
    <a href="./" title="Index Management" class="md-nav__link md-nav__link--active">
      Index Management
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reindexing" title="Reindexing" class="md-nav__link">
    Reindexing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prior-to-reindex" title="Prior to Reindex" class="md-nav__link">
    Prior to Reindex
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-to-reindex" title="Preparing to Reindex" class="md-nav__link">
    Preparing to Reindex
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-a-reindex-job-on-mapreduce" title="Executing a Reindex Job on MapReduce" class="md-nav__link">
    Executing a Reindex Job on MapReduce
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reindex-example-on-mapreduce" title="Reindex Example on MapReduce" class="md-nav__link">
    Reindex Example on MapReduce
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-a-reindex-job-on-janusgraphmanagement" title="Executing a Reindex job on JanusGraphManagement" class="md-nav__link">
    Executing a Reindex job on JanusGraphManagement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-for-janusgraphmanagement" title="Example for JanusGraphManagement" class="md-nav__link">
    Example for JanusGraphManagement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#index-removal" title="Index Removal" class="md-nav__link">
    Index Removal
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-for-index-removal" title="Preparing for Index Removal" class="md-nav__link">
    Preparing for Index Removal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-an-index-removal-job-on-mapreduce" title="Executing an Index Removal Job on MapReduce" class="md-nav__link">
    Executing an Index Removal Job on MapReduce
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-for-mapreduce" title="Example for MapReduce" class="md-nav__link">
    Example for MapReduce
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-an-index-removal-job-on-janusgraphmanagement" title="Executing an Index Removal job on JanusGraphManagement" class="md-nav__link">
    Executing an Index Removal job on JanusGraphManagement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-for-janusgraphmanagement_1" title="Example for JanusGraphManagement" class="md-nav__link">
    Example for JanusGraphManagement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-problems-with-index-management" title="Common Problems with Index Management" class="md-nav__link">
    Common Problems with Index Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#illegalargumentexception-when-starting-job" title="IllegalArgumentException when starting job" class="md-nav__link">
    IllegalArgumentException when starting job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#could-not-find-index" title="Could not find index" class="md-nav__link">
    Could not find index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cassandra-mappers-fail-with-too-many-open-files" title="Cassandra Mappers Fail with "Too many open files"" class="md-nav__link">
    Cassandra Mappers Fail with "Too many open files"
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bulk-loading/" title="Bulk Loading" class="md-nav__link">
      Bulk Loading
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../partitioning/" title="Graph Partitioning" class="md-nav__link">
      Graph Partitioning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../serializer/" title="Datatype and Attribute Serializer Configuration" class="md-nav__link">
      Datatype and Attribute Serializer Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="JanusGraph with TinkerPop’s Hadoop-Gremlin" class="md-nav__link">
      JanusGraph with TinkerPop’s Hadoop-Gremlin
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monitoring/" title="Monitoring JanusGraph" class="md-nav__link">
      Monitoring JanusGraph
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../migrating/" title="Migrating from Titan" class="md-nav__link">
      Migrating from Titan
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data-model/" title="JanusGraph Data model" class="md-nav__link">
      JanusGraph Data model
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../janusgraph-bus/" title="JanusGraph Bus" class="md-nav__link">
      JanusGraph Bus
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Connecting to JanusGraph
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Connecting to JanusGraph
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../connecting/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../connecting/java/" title="Using Java" class="md-nav__link">
      Using Java
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../connecting/python/" title="Using Python" class="md-nav__link">
      Using Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../connecting/dotnet/" title="Using .Net" class="md-nav__link">
      Using .Net
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../development/" title="Development" class="md-nav__link">
      Development
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../appendices/" title="Appendices" class="md-nav__link">
      Appendices
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reindexing" title="Reindexing" class="md-nav__link">
    Reindexing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prior-to-reindex" title="Prior to Reindex" class="md-nav__link">
    Prior to Reindex
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-to-reindex" title="Preparing to Reindex" class="md-nav__link">
    Preparing to Reindex
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-a-reindex-job-on-mapreduce" title="Executing a Reindex Job on MapReduce" class="md-nav__link">
    Executing a Reindex Job on MapReduce
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reindex-example-on-mapreduce" title="Reindex Example on MapReduce" class="md-nav__link">
    Reindex Example on MapReduce
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-a-reindex-job-on-janusgraphmanagement" title="Executing a Reindex job on JanusGraphManagement" class="md-nav__link">
    Executing a Reindex job on JanusGraphManagement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-for-janusgraphmanagement" title="Example for JanusGraphManagement" class="md-nav__link">
    Example for JanusGraphManagement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#index-removal" title="Index Removal" class="md-nav__link">
    Index Removal
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" title="Overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-for-index-removal" title="Preparing for Index Removal" class="md-nav__link">
    Preparing for Index Removal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-an-index-removal-job-on-mapreduce" title="Executing an Index Removal Job on MapReduce" class="md-nav__link">
    Executing an Index Removal Job on MapReduce
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-for-mapreduce" title="Example for MapReduce" class="md-nav__link">
    Example for MapReduce
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-an-index-removal-job-on-janusgraphmanagement" title="Executing an Index Removal job on JanusGraphManagement" class="md-nav__link">
    Executing an Index Removal job on JanusGraphManagement
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-for-janusgraphmanagement_1" title="Example for JanusGraphManagement" class="md-nav__link">
    Example for JanusGraphManagement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-problems-with-index-management" title="Common Problems with Index Management" class="md-nav__link">
    Common Problems with Index Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#illegalargumentexception-when-starting-job" title="IllegalArgumentException when starting job" class="md-nav__link">
    IllegalArgumentException when starting job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#could-not-find-index" title="Could not find index" class="md-nav__link">
    Could not find index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cassandra-mappers-fail-with-too-many-open-files" title="Cassandra Mappers Fail with "Too many open files"" class="md-nav__link">
    Cassandra Mappers Fail with "Too many open files"
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/janusgraph/janusgraph/edit/v0.3/docs/advanced-topics/index-admin.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="index-management">Index Management</h1>
<h2 id="reindexing">Reindexing</h2>
<p><a href="../../basics/index-performance/#graph-index">Graph Index</a> and <a href="../../basics/index-performance/#vertex-centric-indexes">Vertex-centric Indexes</a> describe how to build
graph-global and vertex-centric indexes to improve query performance.
These indexes are immediately available if the indexed keys or labels
have been newly defined in the same management transaction. In this
case, there is no need to reindex the graph and this section can be
skipped. If the indexed keys and labels already existed prior to index
construction it is necessary to reindex the entire graph in order to
ensure that the index contains previously added elements. This section
describes the reindexing process.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Reindexing is a manual process comprised of multiple steps. These
steps must be carefully followed in the right order to avoid index
inconsistencies.</p>
</div>
<h3 id="overview">Overview</h3>
<p>JanusGraph can begin writing incremental index updates right after an
index is defined. However, before the index is complete and usable,
JanusGraph must also take a one-time read pass over all existing graph
elements associated with the newly indexed schema type(s). Once this
reindexing job has completed, the index is fully populated and ready to
be used. The index must then be enabled to be used during query
processing.</p>
<h3 id="prior-to-reindex">Prior to Reindex</h3>
<p>The starting point of the reindexing process is the construction of an
index. Refer to <a href="../../basics/index-performance/">Indexing for Better Performance</a> for a complete discussion of global
graph and vertex-centric indexes. Note, that a global graph index is
uniquely identified by its name. A vertex-centric index is uniquely
identified by the combination of its name and the edge label or property
key on which the index is defined - the name of the latter is referred
to as the <strong>index type</strong> in this section and only applies to
vertex-centric indexes.</p>
<p>After building a new index against existing schema elements it is
recommended to wait a few minutes for the index to be announced to the
cluster. Note the index name (and the index type in case of a
vertex-centric index) since this information is needed when reindexing.</p>
<h3 id="preparing-to-reindex">Preparing to Reindex</h3>
<p>There is a choice between two execution frameworks for reindex jobs:</p>
<ul>
<li>MapReduce</li>
<li>JanusGraphManagement</li>
</ul>
<p>Reindex on MapReduce supports large, horizontally-distributed databases.
Reindex on JanusGraphManagement spawns a single-machine OLAP job. This
is intended for convenience and speed on those databases small enough to
be handled by one machine.</p>
<p>Reindexing requires:</p>
<ul>
<li>The index name (a string — the user provides this to JanusGraph when
    building a new index)</li>
<li>The index type (a string — the name of the edge label or property
    key on which the vertex-centric index is built). This applies only
    to vertex-centric indexes - leave blank for global graph indexes.</li>
</ul>
<h3 id="executing-a-reindex-job-on-mapreduce">Executing a Reindex Job on MapReduce</h3>
<p>The recommended way to generate and run a reindex job on MapReduce is
through the <code>MapReduceIndexManagement</code> class. Here is a rough outline of
the steps to run a reindex job using this class:</p>
<ul>
<li>Open a <code>JanusGraph</code> instance</li>
<li>Pass the graph instance into <code>MapReduceIndexManagement</code>'s constructor</li>
<li>Call <code>updateIndex(&lt;index&gt;, SchemaAction.REINDEX)</code> on the <code>MapReduceIndexManagement</code> instance</li>
<li>If the index has not yet been enabled, enable it through <code>JanusGraphManagement</code></li>
</ul>
<p>This class implements an <code>updateIndex</code> method that supports only the
<code>REINDEX</code> and <code>REMOVE_INDEX</code> actions for its <code>SchemaAction</code> parameter.
The class starts a Hadoop MapReduce job using the Hadoop configuration
and jars on the classpath. Both Hadoop 1 and 2 are supported. This class
gets metadata about the index and storage backend (e.g. the Cassandra
partitioner) from the <code>JanusGraph</code> instance given to its constructor.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">JanusGraphFactory</span><span class="o">.</span><span class="na">open</span><span class="o">(...)</span>
<span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">mr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MapReduceIndexManagement</span><span class="o">(</span><span class="n">graph</span><span class="o">)</span>
<span class="n">mr</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">mgmt</span><span class="o">.</span><span class="na">getRelationIndex</span><span class="o">(</span><span class="n">mgmt</span><span class="o">.</span><span class="na">getRelationType</span><span class="o">(</span><span class="s2">&quot;battled&quot;</span><span class="o">),</span> <span class="s2">&quot;battlesByTime&quot;</span><span class="o">),</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REINDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
</pre></div>
</td></tr></table></p>
<h4 id="reindex-example-on-mapreduce">Reindex Example on MapReduce</h4>
<p>The following Gremlin snippet outlines all steps of the MapReduce
reindex process in one self-contained example using minimal dummy data
against the Cassandra storage backend.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Open a graph</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">JanusGraphFactory</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s2">&quot;conf/janusgraph-cql-es.properties&quot;</span><span class="o">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">traversal</span><span class="o">()</span>

<span class="c1">// Define a property</span>
<span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">desc</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">.</span><span class="na">makePropertyKey</span><span class="o">(</span><span class="s2">&quot;desc&quot;</span><span class="o">).</span><span class="na">dataType</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">make</span><span class="o">()</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Insert some data</span>
<span class="n">graph</span><span class="o">.</span><span class="na">addVertex</span><span class="o">(</span><span class="s2">&quot;desc&quot;</span><span class="o">,</span> <span class="s2">&quot;foo bar&quot;</span><span class="o">)</span>
<span class="n">graph</span><span class="o">.</span><span class="na">addVertex</span><span class="o">(</span><span class="s2">&quot;desc&quot;</span><span class="o">,</span> <span class="s2">&quot;foo baz&quot;</span><span class="o">)</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Run a query -- note the planner warning recommending the use of an index</span>
<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s2">&quot;desc&quot;</span><span class="o">,</span> <span class="n">containsText</span><span class="o">(</span><span class="s2">&quot;baz&quot;</span><span class="o">))</span>

<span class="c1">// Create an index</span>
<span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>

<span class="n">desc</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">.</span><span class="na">getPropertyKey</span><span class="o">(</span><span class="s2">&quot;desc&quot;</span><span class="o">)</span>
<span class="n">mixedIndex</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">.</span><span class="na">buildIndex</span><span class="o">(</span><span class="s2">&quot;mixedExample&quot;</span><span class="o">,</span> <span class="n">Vertex</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">addKey</span><span class="o">(</span><span class="n">desc</span><span class="o">).</span><span class="na">buildMixedIndex</span><span class="o">(</span><span class="s2">&quot;search&quot;</span><span class="o">)</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Rollback or commit transactions on the graph which predate the index definition</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">rollback</span><span class="o">()</span>

<span class="c1">// Block until the SchemaStatus transitions from INSTALLED to REGISTERED</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">ManagementSystem</span><span class="o">.</span><span class="na">awaitGraphIndexStatus</span><span class="o">(</span><span class="n">graph</span><span class="o">,</span> <span class="s2">&quot;mixedExample&quot;</span><span class="o">).</span><span class="na">call</span><span class="o">()</span>

<span class="c1">// Run a JanusGraph-Hadoop job to reindex</span>
<span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">mr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MapReduceIndexManagement</span><span class="o">(</span><span class="n">graph</span><span class="o">)</span>
<span class="n">mr</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">mgmt</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s2">&quot;mixedExample&quot;</span><span class="o">),</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REINDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>

<span class="c1">// Enable the index</span>
<span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">mgmt</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s2">&quot;mixedExample&quot;</span><span class="o">),</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">ENABLE_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Block until the SchemaStatus is ENABLED</span>
<span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">ManagementSystem</span><span class="o">.</span><span class="na">awaitGraphIndexStatus</span><span class="o">(</span><span class="n">graph</span><span class="o">,</span> <span class="s2">&quot;mixedExample&quot;</span><span class="o">).</span><span class="na">status</span><span class="o">(</span><span class="n">SchemaStatus</span><span class="o">.</span><span class="na">ENABLED</span><span class="o">).</span><span class="na">call</span><span class="o">()</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">rollback</span><span class="o">()</span>

<span class="c1">// Run a query -- JanusGraph will use the new index, no planner warning</span>
<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s2">&quot;desc&quot;</span><span class="o">,</span> <span class="n">containsText</span><span class="o">(</span><span class="s2">&quot;baz&quot;</span><span class="o">))</span>

<span class="c1">// Concerned that JanusGraph could have read cache in that last query, instead of relying on the index?</span>
<span class="c1">// Start a new instance to rule out cache hits.  Now we&#39;re definitely using the index.</span>
<span class="n">graph</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">JanusGraphFactory</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s2">&quot;conf/janusgraph-cql-es.properties&quot;</span><span class="o">)</span>
<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s2">&quot;desc&quot;</span><span class="o">,</span> <span class="n">containsText</span><span class="o">(</span><span class="s2">&quot;baz&quot;</span><span class="o">))</span>
</pre></div>
</td></tr></table></p>
<h3 id="executing-a-reindex-job-on-janusgraphmanagement">Executing a Reindex job on JanusGraphManagement</h3>
<p>To run a reindex job on JanusGraphManagement, invoke
<code>JanusGraphManagement.updateIndex</code> with the <code>SchemaAction.REINDEX</code>
argument. For example:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;indexName&#39;</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REINDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
</pre></div>
</td></tr></table></p>
<h4 id="example-for-janusgraphmanagement">Example for JanusGraphManagement</h4>
<p>The following loads some sample data into a BerkeleyDB-backed JanusGraph
database, defines an index after the fact, reindexes using
JanusGraphManagement, and finally enables and uses the index:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">org.janusgraph.graphdb.database.management.ManagementSystem</span>

<span class="c1">// Load some data from a file without any predefined schema</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">JanusGraphFactory</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s1">&#39;conf/janusgraph-berkeleyje.properties&#39;</span><span class="o">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">traversal</span><span class="o">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">makePropertyKey</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">).</span><span class="na">dataType</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">cardinality</span><span class="o">(</span><span class="n">Cardinality</span><span class="o">.</span><span class="na">LIST</span><span class="o">).</span><span class="na">make</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">makePropertyKey</span><span class="o">(</span><span class="s1">&#39;lang&#39;</span><span class="o">).</span><span class="na">dataType</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">cardinality</span><span class="o">(</span><span class="n">Cardinality</span><span class="o">.</span><span class="na">LIST</span><span class="o">).</span><span class="na">make</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">makePropertyKey</span><span class="o">(</span><span class="s1">&#39;age&#39;</span><span class="o">).</span><span class="na">dataType</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">cardinality</span><span class="o">(</span><span class="n">Cardinality</span><span class="o">.</span><span class="na">LIST</span><span class="o">).</span><span class="na">make</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
<span class="n">graph</span><span class="o">.</span><span class="na">io</span><span class="o">(</span><span class="n">IoCore</span><span class="o">.</span><span class="na">gryo</span><span class="o">()).</span><span class="na">readGraph</span><span class="o">(</span><span class="s1">&#39;data/tinkerpop-modern.gio&#39;</span><span class="o">)</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Run a query -- note the planner warning recommending the use of an index</span>
<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;lop&#39;</span><span class="o">)</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">rollback</span><span class="o">()</span>

<span class="c1">// Create an index</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">buildIndex</span><span class="o">(</span><span class="s1">&#39;names&#39;</span><span class="o">,</span> <span class="n">Vertex</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">addKey</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">getPropertyKey</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)).</span><span class="na">buildCompositeIndex</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Block until the SchemaStatus transitions from INSTALLED to REGISTERED</span>
<span class="n">ManagementSystem</span><span class="o">.</span><span class="na">awaitGraphIndexStatus</span><span class="o">(</span><span class="n">graph</span><span class="o">,</span> <span class="s1">&#39;names&#39;</span><span class="o">).</span><span class="na">status</span><span class="o">(</span><span class="n">SchemaStatus</span><span class="o">.</span><span class="na">REGISTERED</span><span class="o">).</span><span class="na">call</span><span class="o">()</span>

<span class="c1">// Reindex using JanusGraphManagement</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;names&#39;</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REINDEX</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Enable the index</span>
<span class="n">ManagementSystem</span><span class="o">.</span><span class="na">awaitGraphIndexStatus</span><span class="o">(</span><span class="n">graph</span><span class="o">,</span> <span class="s1">&#39;names&#39;</span><span class="o">).</span><span class="na">status</span><span class="o">(</span><span class="n">SchemaStatus</span><span class="o">.</span><span class="na">ENABLED</span><span class="o">).</span><span class="na">call</span><span class="o">()</span>

<span class="c1">// Run a query -- JanusGraph will use the new index, no planner warning</span>
<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;lop&#39;</span><span class="o">)</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">rollback</span><span class="o">()</span>

<span class="c1">// Concerned that JanusGraph could have read cache in that last query, instead of relying on the index?</span>
<span class="c1">// Start a new instance to rule out cache hits.  Now we&#39;re definitely using the index.</span>
<span class="n">graph</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">JanusGraphFactory</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s2">&quot;conf/janusgraph-berkeleyje.properties&quot;</span><span class="o">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">traversal</span><span class="o">()</span>
<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;lop&#39;</span><span class="o">)</span>
</pre></div>
</td></tr></table></p>
<h2 id="index-removal">Index Removal</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Index removal is a manual process comprised of multiple steps. These
steps must be carefully followed in the right order to avoid index
inconsistencies.</p>
</div>
<h3 id="overview_1">Overview</h3>
<p>Index removal is a two-stage process. In the first stage, one JanusGraph
signals to all others via the storage backend that the index is slated
for deletion. This changes the index’s state to <code>DISABLED</code>. At that
point, JanusGraph stops using the index to answer queries and stops
incrementally updating the index. Index-related data in the storage
backend remains present but ignored.</p>
<p>The second stage depends on whether the index is mixed or composite. A
composite index can be deleted via JanusGraph. As with reindexing,
removal can be done through either MapReduce or JanusGraphManagement.
However, a mixed index must be manually dropped in the index backend;
JanusGraph does not provide an automated mechanism to delete an index
from its index backend.</p>
<p>Index removal deletes everything associated with the index except its
schema definition and its <code>DISABLED</code> state. This schema stub for the
index remains even after deletion, though its storage footprint is
negligible and fixed.</p>
<h3 id="preparing-for-index-removal">Preparing for Index Removal</h3>
<p>If the index is currently enabled, it should first be disabled. This is
done through the <code>ManagementSystem</code>.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">rindex</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">.</span><span class="na">getRelationIndex</span><span class="o">(</span><span class="n">mgmt</span><span class="o">.</span><span class="na">getRelationType</span><span class="o">(</span><span class="s2">&quot;battled&quot;</span><span class="o">),</span> <span class="s2">&quot;battlesByTime&quot;</span><span class="o">)</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">rindex</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">DISABLE_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">gindex</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s2">&quot;byName&quot;</span><span class="o">)</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">gindex</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">DISABLE_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
</pre></div>
</td></tr></table></p>
<p>Once the status of all keys on the index changes to <code>DISABLED</code>, the
index is ready to be removed. A utility in ManagementSystem can automate
the wait-for-<code>DISABLED</code> step:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">ManagementSystem</span><span class="o">.</span><span class="na">awaitGraphIndexStatus</span><span class="o">(</span><span class="n">graph</span><span class="o">,</span> <span class="s1">&#39;byName&#39;</span><span class="o">).</span><span class="na">status</span><span class="o">(</span><span class="n">SchemaStatus</span><span class="o">.</span><span class="na">DISABLED</span><span class="o">).</span><span class="na">call</span><span class="o">()</span>
</pre></div>
</td></tr></table></p>
<p>After a composite index is <code>DISABLED</code>, there is a choice between two
execution frameworks for its removal:</p>
<ul>
<li>MapReduce</li>
<li>JanusGraphManagement</li>
</ul>
<p>Index removal on MapReduce supports large, horizontally-distributed
databases. Index removal on JanusGraphManagement spawns a single-machine
OLAP job. This is intended for convenience and speed on those databases
small enough to be handled by one machine.</p>
<p>Index removal requires:</p>
<ul>
<li>The index name (a string — the user provides this to JanusGraph when
    building a new index)</li>
<li>The index type (a string — the name of the edge label or property
    key on which the vertex-centric index is built). This applies only
    to vertex-centric indexes - leave blank for global graph indexes.</li>
</ul>
<p>As noted in the overview, a mixed index must be manually dropped from
the indexing backend. Neither the MapReduce framework nor the
JanusGraphManagement framework will delete a mixed backend from the
indexing backend.</p>
<h3 id="executing-an-index-removal-job-on-mapreduce">Executing an Index Removal Job on MapReduce</h3>
<p>As with reindexing, the recommended way to generate and run an index
removal job on MapReduce is through the <code>MapReduceIndexManagement</code>
class. Here is a rough outline of the steps to run an index removal job
using this class:</p>
<ul>
<li>Open a <code>JanusGraph</code> instance</li>
<li>If the index has not yet been disabled, disable it through <code>JanusGraphManagement</code></li>
<li>Pass the graph instance into <code>MapReduceIndexManagement</code>'s constructor</li>
<li>Call <code>updateIndex(&lt;index&gt;, SchemaAction.REMOVE_INDEX)</code></li>
</ul>
<p>A commented code example follows in the next subsection.</p>
<h4 id="example-for-mapreduce">Example for MapReduce</h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">org.janusgraph.graphdb.database.management.ManagementSystem</span>

<span class="c1">// Load the &quot;Graph of the Gods&quot; sample data</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">JanusGraphFactory</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s1">&#39;conf/janusgraph-cql-es.properties&#39;</span><span class="o">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">traversal</span><span class="o">()</span>
<span class="n">GraphOfTheGodsFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">graph</span><span class="o">)</span>

<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;jupiter&#39;</span><span class="o">)</span>

<span class="c1">// Disable the &quot;name&quot; composite index</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">nameIndex</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">nameIndex</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">DISABLE_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Block until the SchemaStatus transitions from INSTALLED to REGISTERED</span>
<span class="n">ManagementSystem</span><span class="o">.</span><span class="na">awaitGraphIndexStatus</span><span class="o">(</span><span class="n">graph</span><span class="o">,</span> <span class="s1">&#39;name&#39;</span><span class="o">).</span><span class="na">status</span><span class="o">(</span><span class="n">SchemaStatus</span><span class="o">.</span><span class="na">DISABLED</span><span class="o">).</span><span class="na">call</span><span class="o">()</span>

<span class="c1">// Delete the index using MapReduceIndexJobs</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">mr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MapReduceIndexManagement</span><span class="o">(</span><span class="n">graph</span><span class="o">)</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">),</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REMOVE_INDEX</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">commit</span><span class="o">()</span>
<span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>

<span class="c1">// Index still shows up in management interface as DISABLED -- this is normal</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
<span class="n">idx</span><span class="o">.</span><span class="na">getIndexStatus</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">getPropertyKey</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">))</span>
<span class="n">m</span><span class="o">.</span><span class="na">rollback</span><span class="o">()</span>

<span class="c1">// JanusGraph should issue a warning about this query requiring a full scan</span>
<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;jupiter&#39;</span><span class="o">)</span>
</pre></div>
</td></tr></table>

<h3 id="executing-an-index-removal-job-on-janusgraphmanagement">Executing an Index Removal job on JanusGraphManagement</h3>
<p>To run an index removal job on JanusGraphManagement, invoke
<code>JanusGraphManagement.updateIndex</code> with the <code>SchemaAction.REMOVE_INDEX</code>
argument. For example:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;indexName&#39;</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REMOVE_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
</pre></div>
</td></tr></table></p>
<h4 id="example-for-janusgraphmanagement_1">Example for JanusGraphManagement</h4>
<p>The following loads some indexed sample data into a BerkeleyDB-backed
JanusGraph database, then disables and removes the index through
JanusGraphManagement:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">org.janusgraph.graphdb.database.management.ManagementSystem</span>

<span class="c1">// Load the &quot;Graph of the Gods&quot; sample data</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">JanusGraphFactory</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s1">&#39;conf/janusgraph-cql-es.properties&#39;</span><span class="o">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">traversal</span><span class="o">()</span>
<span class="n">GraphOfTheGodsFactory</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">graph</span><span class="o">)</span>

<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;jupiter&#39;</span><span class="o">)</span>

<span class="c1">// Disable the &quot;name&quot; composite index</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">nameIndex</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">nameIndex</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">DISABLE_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">commit</span><span class="o">()</span>

<span class="c1">// Block until the SchemaStatus transitions from INSTALLED to REGISTERED</span>
<span class="n">ManagementSystem</span><span class="o">.</span><span class="na">awaitGraphIndexStatus</span><span class="o">(</span><span class="n">graph</span><span class="o">,</span> <span class="s1">&#39;name&#39;</span><span class="o">).</span><span class="na">status</span><span class="o">(</span><span class="n">SchemaStatus</span><span class="o">.</span><span class="na">DISABLED</span><span class="o">).</span><span class="na">call</span><span class="o">()</span>

<span class="c1">// Delete the index using JanusGraphManagement</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">nameIndex</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">nameIndex</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REMOVE_INDEX</span><span class="o">)</span>
<span class="n">m</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
<span class="n">graph</span><span class="o">.</span><span class="na">tx</span><span class="o">().</span><span class="na">commit</span><span class="o">()</span>

<span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">nameIndex</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>

<span class="n">g</span><span class="o">.</span><span class="na">V</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;jupiter&#39;</span><span class="o">)</span>
</pre></div>
</td></tr></table></p>
<h2 id="common-problems-with-index-management">Common Problems with Index Management</h2>
<h3 id="illegalargumentexception-when-starting-job">IllegalArgumentException when starting job</h3>
<p>When a reindexing job is started shortly after a the index has been
built, the job might fail with an exception like one of the following:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>The index mixedExample is in an invalid state and cannot be indexed.
The following index keys have invalid status: desc has status INSTALLED
(status must be one of [REGISTERED, ENABLED])

The index mixedExample is in an invalid state and cannot be indexed.
The index has status INSTALLED, but one of [REGISTERED, ENABLED] is required
</pre></div>
</td></tr></table>

<p>When an index is built, its existence is broadcast to all other
JanusGraph instances in the cluster. Those must acknowledge the
existence of the index before the reindexing process can be started. The
acknowledgments can take a while to come in depending on the size of the
cluster and the connection speed. Hence, one should wait a few minutes
after building the index and before starting the reindex process.</p>
<p>Note, that the acknowledgment might fail due to JanusGraph instance
failure. In other words, the cluster might wait indefinitely on the
acknowledgment of a failed instance. In this case, the user must
manually remove the failed instance from the cluster registry as
described in <a href="../recovery/">Failure &amp; Recovery</a>. After the cluster state has been
restored, the acknowledgment process must be reinitiated by manually
registering the index again in the management system.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">mgmt</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="na">openManagement</span><span class="o">()</span>
<span class="n">rindex</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">.</span><span class="na">getRelationIndex</span><span class="o">(</span><span class="n">mgmt</span><span class="o">.</span><span class="na">getRelationType</span><span class="o">(</span><span class="s2">&quot;battled&quot;</span><span class="o">),</span><span class="s2">&quot;battlesByTime&quot;</span><span class="o">)</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">rindex</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REGISTER_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">gindex</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">.</span><span class="na">getGraphIndex</span><span class="o">(</span><span class="s2">&quot;byName&quot;</span><span class="o">)</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">updateIndex</span><span class="o">(</span><span class="n">gindex</span><span class="o">,</span> <span class="n">SchemaAction</span><span class="o">.</span><span class="na">REGISTER_INDEX</span><span class="o">).</span><span class="na">get</span><span class="o">()</span>
<span class="n">mgmt</span><span class="o">.</span><span class="na">commit</span><span class="o">()</span>
</pre></div>
</td></tr></table>

<p>After waiting a few minutes for the acknowledgment to arrive the reindex
job should start successfully.</p>
<h3 id="could-not-find-index">Could not find index</h3>
<p>This exception in the reindexing job indicates that an index with the
given name does not exist or that the name has not been specified
correctly. When reindexing a global graph index, only the name of the
index as defined when building the index should be specified. When
reindexing a global graph index, the name of the index must be given in
addition to the name of the edge label or property key on which the
vertex-centric index is defined.</p>
<h3 id="cassandra-mappers-fail-with-too-many-open-files">Cassandra Mappers Fail with "Too many open files"</h3>
<p>The end of the exception stacktrace may look like this:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">SocketException</span><span class="o">:</span> <span class="n">Too</span> <span class="n">many</span> <span class="n">open</span> <span class="n">files</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">Socket</span><span class="o">.</span><span class="na">createImpl</span><span class="o">(</span><span class="n">Socket</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">447</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">Socket</span><span class="o">.</span><span class="na">getImpl</span><span class="o">(</span><span class="n">Socket</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">510</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">Socket</span><span class="o">.</span><span class="na">setSoLinger</span><span class="o">(</span><span class="n">Socket</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">988</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">thrift</span><span class="o">.</span><span class="na">transport</span><span class="o">.</span><span class="na">TSocket</span><span class="o">.</span><span class="na">initSocket</span><span class="o">(</span><span class="n">TSocket</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">118</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">thrift</span><span class="o">.</span><span class="na">transport</span><span class="o">.</span><span class="na">TSocket</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="n">TSocket</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">109</span><span class="o">)</span>
</pre></div>
</td></tr></table></p>
<p>When running Cassandra with virtual nodes enabled, the number of virtual
nodes seems to set a floor under the number of mappers. Cassandra may
generate more mappers than virtual nodes for clusters with lots of data,
but it seems to generate at least as many mappers as there are virtual
nodes even though the cluster might be empty or close to empty. The
default is 256 as of this writing.</p>
<p>Each mapper opens and quickly closes several sockets to Cassandra. The
kernel on the client side of those closed sockets goes into asynchronous
TIME_WAIT, since Thrift uses SO_LINGER. Only a small number of sockets
are open at any one time — usually low single digits — but potentially
many lingering sockets can accumulate in TIME_WAIT. This accumulation
is most pronounced when running a reindex job locally (not on a
distributed MapReduce cluster), since all of those client-side
TIME_WAIT sockets are lingering on a single client machine instead of
being spread out across many machines in a cluster. Combined with the
floor of 256 mappers, a reindex job can open thousands of sockets of the
course of its execution. When these sockets all linger in TIME_WAIT on
the same client, they have the potential to reach the open-files ulimit,
which also controls the number of open sockets. The open-files ulimit is
often set to 1024.</p>
<p>Here are a few suggestions for dealing with the "Too many open files"
problem during reindexing on a single machine:</p>
<ul>
<li>
<p>Reduce the maximum size of the Cassandra connection pool. For
    example, consider setting the cassandrathrift storage backend’s
    <code>max-active</code> and <code>max-idle</code> options to 1 each, and setting
    <code>max-total</code> to -1. See <a href="../../basics/configuration-reference/">Configuration Reference</a> for full listings of
    connection pool settings on the Cassandra storage backends.</p>
</li>
<li>
<p>Increase the <code>nofile</code> ulimit. The ideal value depends on the size of
    the Cassandra dataset and the throughput of the reindex mappers; if
    starting at 1024, try an order of magnitude larger: 10000. This is
    just necessary to sustain lingering TIME_WAIT sockets. The reindex
    job won’t try to open nearly that many sockets at once.</p>
</li>
<li>
<p>Run the reindex task on a multi-node MapReduce cluster to spread out
    the socket load.</p>
</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../recovery/" title="Failure & Recovery" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Failure & Recovery
              </span>
            </div>
          </a>
        
        
          <a href="../bulk-loading/" title="Bulk Loading" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Bulk Loading
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 JanusGraph Authors. All rights reserved.<br> The Linux Foundation has registered trademarks and uses trademarks. For a list of<br> trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a> page.<br> Cassandra, Groovy, HBase, Hadoop, Lucene, Solr, and TinkerPop are trademarks of the Apache Software Foundation.<br> Berkeley DB and Berkeley DB Java Edition are trademarks of Oracle.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../theme/js/structor-menu.js"></script>
      
    
  </body>
</html>